<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="McCoy Reynolds Becker">
<meta name="dcterms.date" content="2022-12-01">

<title>Gen ⊗ JAX - Incremental computation for generative functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../concepts/gradient_interfaces/gradient_interfaces.html" rel="next">
<link href="../../concepts/combinators/intro_to_combinators.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta property="og:title" content="Gen ⊗ JAX - Incremental computation for generative functions">
<meta property="og:description" content="This notebook describes GenJAX’s support for incremental computing, focused on the update generative function interface method. We also describe the cache primitive for the BuiltinGenerativeFunction language - which allows storing of deterministic state inside of BuiltinTrace instances. We discuss how both incremental computing and cache expose optimization opportunities which can be utilized by inference programmers.">
<meta property="og:site-name" content="Gen ⊗ JAX">
</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../concepts/introduction/intro_to_genjax.html">Concepts</a></li><li class="breadcrumb-item"><a href="../../concepts/incremental_computation/incremental.html">Incremental computing</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="../../" title="Home" class="quarto-navigation-tool px-1" aria-label="Home"><i class="bi bi-house-heart"></i></a>
    <a href="http://probcomp.csail.mit.edu/" title="MIT Probabilistic Computing Project" class="quarto-navigation-tool px-1" aria-label="MIT Probabilistic Computing Project"><i class="bi bi-building"></i></a>
    <a href="https://github.com/probcomp/genjax" title="GitHub repository" class="quarto-navigation-tool px-1" aria-label="GitHub repository"><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Concepts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/introduction/intro_to_genjax.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/combinators/intro_to_combinators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative function combinators</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/incremental_computation/incremental.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Incremental computing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/gradient_interfaces/gradient_interfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Differentiable programming</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Inference programming</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../intermediate/gaussian_processes/gaussian_processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../intermediate/goal_inference/goal_inference.ipynb" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agent goal inference</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Advanced inference programming</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../advanced/recurse_combinator/recurse_combinator.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recurse combinator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../advanced/prox/prox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>Prox</code> (approximate densities)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../advanced/smc_language/smc_language.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SMC inference language</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Internals</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../internals/impl_builtin_language/impl_builtin_language.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic semantics via interpreters</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-update-used-for" id="toc-what-is-update-used-for" class="nav-link active" data-scroll-target="#what-is-update-used-for">What is <code>update</code> used for?</a>
  <ul class="collapse">
  <li><a href="#pedagogical-example" id="toc-pedagogical-example" class="nav-link" data-scroll-target="#pedagogical-example">Pedagogical example</a></li>
  </ul></li>
  <li><a href="#change-information" id="toc-change-information" class="nav-link" data-scroll-target="#change-information">Change information</a>
  <ul class="collapse">
  <li><a href="#diffs-for-distributions" id="toc-diffs-for-distributions" class="nav-link" data-scroll-target="#diffs-for-distributions">Diffs for distributions</a></li>
  <li><a href="#diff-propagation-in-the-builtingenerativefunction-language" id="toc-diff-propagation-in-the-builtingenerativefunction-language" class="nav-link" data-scroll-target="#diff-propagation-in-the-builtingenerativefunction-language">Diff propagation in the <code>BuiltinGenerativeFunction</code> language</a></li>
  </ul></li>
  <li><a href="#cache-change-aware-memoization" id="toc-cache-change-aware-memoization" class="nav-link" data-scroll-target="#cache-change-aware-memoization"><code>cache</code>: change aware memoization</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/probcomp/genjax/blob/main/concepts/incremental_computation/incremental.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/probcomp/genjax/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Incremental computation for generative functions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>McCoy Reynolds Becker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 1, 2022</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    This notebook describes GenJAX’s support for incremental computing, focused on the <code>update</code> generative function interface method. We also describe the <code>cache</code> primitive for the <code>BuiltinGenerativeFunction</code> language - which allows storing of deterministic state inside of <code>BuiltinTrace</code> instances. We discuss how both incremental computing and <code>cache</code> expose optimization opportunities which can be utilized by inference programmers.
  </div>
</div>

</header>

<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'svg'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.tree_util <span class="im">as</span> jtu</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dataclasses</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> genjax</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> genjax <span class="im">import</span> Diff</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Any</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty printing.</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>console <span class="op">=</span> genjax.pretty(width<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproducibility.</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> jax.random.PRNGKey(<span class="dv">314159</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>update</code> interface method for generative functions defines an update operation on traces produced by generative functions.</p>
<p><code>update</code> allows the user to provide new constraints, as well as new arguments, and returns an updated trace which is consistent with the new constraints, as well as an incremental importance weight which measures the difference between the new and old constraints under the model. <code>update</code> is used to implement many types of iterative MCMC inference families.</p>
<p>The specification of <code>update</code> only requires that a modeling language support the above behavior - nonetheless, modeling languages can implement <code>update</code> with custom optimizations to improve the cost of repeatedly calling <code>update</code> (e.g.&nbsp;an iterative MCMC inference procedure).</p>
<div class="page-columns page-full"><p>In this notebook, we’ll be focused on these optimization opportunities within the implementation of <code>update</code> for the <code>BuiltinGenerativeFunction</code> language. We’ll describe a system which supports incremental computing capabilities using change information (called <code>Diff</code> in the codebase) propagation.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Think of a value of <code>Diff</code> type as representing a new value <span class="math inline">\(v^\prime\)</span> using a decomposition <span class="math inline">\(v^\prime = v \oplus dv\)</span> where <span class="math inline">\(dv\)</span> is the change to the value and <span class="math inline">\(v\)</span> is the original value.</p></li></div></div>
<p>While we’ll be focused on the distribution and builtin languages, this system is also applicable to the combinator implementations of <code>update</code>. In another notebook, we’ll see how the incremental computing system can be used to efficiently compute <code>update</code> for <code>UnfoldCombinator</code>.</p>
<section id="what-is-update-used-for" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-is-update-used-for">What is <code>update</code> used for?</h2>
<p>Before we discuss how <code>update</code> can be optimized by a generative function implementor, it’s worth constructing a simple example which shows how <code>update</code> is used, and to show why optimizing <code>update</code> is worthwhile.</p>
<p>One common usage of <code>update</code> is in MCMC algorithm kernels. MCMC is often repeatedly applied to generate a chain of samples: any optimization opportunities that we identify and take advantage of will provide runtime gains which are multiplied over the length of the chain.</p>
<p>Let’s example this scenario using a pedagogical example - remember that the potential optimization pattern (based upon random variable dependency information) we’ll describe extends to all generative functions.</p>
<section id="pedagogical-example" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="pedagogical-example">Pedagogical example</h3>
<p>Consider the following generative function:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@genjax.gen</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(x):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> genjax.trace(<span class="st">"a"</span>, genjax.Normal)(x, <span class="fl">1.0</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> genjax.trace(<span class="st">"b"</span>, genjax.Normal)(x, <span class="fl">1.0</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> genjax.trace(<span class="st">"c"</span>, genjax.Normal)(a <span class="op">+</span> b, <span class="fl">1.0</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The variable dependency graph is shown below.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  x[Argument] --&gt; a[a]
  x --&gt; b[b]
  a --&gt; c[c]
  b --&gt; c
  c --&gt; r[Return]
</pre>
</div>
</div>
</div>
</div>
<p>Now, when we simulate a trace from this model - we get choices for <code>"a"</code>, <code>"b"</code>, and <code>"c"</code>.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>key, tr <span class="op">=</span> model.simulate(key, (<span class="fl">2.0</span>,))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>tr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">BuiltinTrace</span>
├── gen_fn
│   └── <span style="font-weight: bold">BuiltinGenerativeFunction</span>
│       └── source
│           └── &lt;function model&gt;
├── args
│   └── <span style="font-weight: bold">tuple</span>
│       └── (const) 2.0
├── retval
│   └──  f32[]
├── choices
│   └── <span style="font-weight: bold">Trie</span>
│       ├── <span style="font-weight: bold">:a</span>
│       │   └── <span style="font-weight: bold">DistributionTrace</span>
│       │       ├── gen_fn
│       │       │   └── <span style="font-weight: bold">_Normal</span>
│       │       ├── args
│       │       │   └── <span style="font-weight: bold">tuple</span>
│       │       │       ├── (const) 2.0
│       │       │       └── (const) 1.0
│       │       ├── value
│       │       │   └──  f32[]
│       │       └── score
│       │           └──  f32[]
│       ├── <span style="font-weight: bold">:b</span>
│       │   └── <span style="font-weight: bold">DistributionTrace</span>
│       │       ├── gen_fn
│       │       │   └── <span style="font-weight: bold">_Normal</span>
│       │       ├── args
│       │       │   └── <span style="font-weight: bold">tuple</span>
│       │       │       ├── (const) 2.0
│       │       │       └── (const) 1.0
│       │       ├── value
│       │       │   └──  f32[]
│       │       └── score
│       │           └──  f32[]
│       └── <span style="font-weight: bold">:c</span>
│           └── <span style="font-weight: bold">DistributionTrace</span>
│               ├── gen_fn
│               │   └── <span style="font-weight: bold">_Normal</span>
│               ├── args
│               │   └── <span style="font-weight: bold">tuple</span>
│               │       ├──  f32[]
│               │       └── (const) 1.0
│               ├── value
│               │   └──  f32[]
│               └── score
│                   └──  f32[]
├── cache
│   └── <span style="font-weight: bold">Trie</span>
└── score
    └──  f32[]
</pre>
</div>
</div>
<p>Iterative inference techniques like Metropolis-Hastings (and other MCMC methods) start with an initial trace, propose an update to the trace using a proposal, and then compute a criterion for accepting or rejecting the update.</p>
<p>In Metropolis-Hastings, the criterion involves an <em>accept-reject ratio</em> computation - which requires computing the probability of transitioning from the current trace to the new trace, as well as the probability of transitioning from the new trace back to the current trace, under a kernel defined by the algorithm.</p>
<p>The library implementation of Metropolis-Hastings is shown below - <code>MetropolisHastings.apply</code> shows the main content of the algorithm (it’s safe to ignore other methods for now).</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclasses.dataclass</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MetropolisHastings(genjax.MCMCKernel):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    selection: genjax.Selection</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    proposal: genjax.GenerativeFunction</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> flatten(<span class="va">self</span>):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (), (<span class="va">self</span>.selection, <span class="va">self</span>.proposal)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">apply</span>(<span class="va">self</span>, key, trace: genjax.Trace, proposal_args: Tuple):</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> trace.get_gen_fn()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        model_args <span class="op">=</span> trace.get_args()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        proposal_args_fwd <span class="op">=</span> (trace.get_choices(), <span class="op">*</span>proposal_args)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        key, proposal_tr <span class="op">=</span> <span class="va">self</span>.proposal.simulate(key, proposal_args_fwd)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        fwd_weight <span class="op">=</span> proposal_tr.get_score()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        diffs <span class="op">=</span> jtu.tree_map(Diff.no_change, model_args)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        key, (_, weight, new, discard) <span class="op">=</span> model.update(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            key, trace, proposal_tr.get_choices(), diffs</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        proposal_args_bwd <span class="op">=</span> (new, <span class="op">*</span>proposal_args)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        key, (bwd_weight, _) <span class="op">=</span> <span class="va">self</span>.proposal.importance(key, discard, proposal_args_bwd)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> weight <span class="op">-</span> fwd_weight <span class="op">+</span> bwd_weight</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        check <span class="op">=</span> jnp.log(random.uniform(sub_key)) <span class="op">&lt;</span> alpha</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            key,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            jax.lax.cond(</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                check,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> <span class="op">*</span>args: (new, <span class="va">True</span>),</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> <span class="op">*</span>args: (trace, <span class="va">False</span>),</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reversal(<span class="va">self</span>):</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This computation involves <code>update</code> - which <em>incrementally</em> updates a trace to be consistent with new arguments and constraints, and computes an importance weight (the difference between the trace’s new score and the old score).</p>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>In the invocation of <code>update</code>, there’s an interesting not-yet-explained argument: <code>diffs</code> - a tuple of <code>Diff</code> values, which represent <em>changes</em> to the original arguments of the call which produced the trace which we are attempting to update. We’ll come back to these values in a moment.</p>
</div>
</div>
</div>
<p>If we naively evaluate the required log probability by re-evaluating the entire model - we’re performing extra computation. We can see this by considering a specific target address - let’s consider <code>"a"</code>. If the update changes <code>"a"</code>, what other generative function calls do we need to visit to compute the correct update - both to the trace, and the importance weight?</p>
<p>The graph below shows the answer.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  x[Argument] --&gt; a[&lt;b&gt;a&lt;/b&gt;]
  x --&gt; b[b]
  a --&gt; c[&lt;b&gt;c&lt;/b&gt;]
  b --&gt; c
  c --&gt; r[Return]
  style a fill:#f9f,stroke:#333,stroke-width:4px
  style c fill:#f9f,stroke:#333,stroke-width:4px
</pre>
</div>
</div>
</div>
</div>
<p>An update to <code>"a"</code> requires that we re-evaluate the log probability at <code>"c"</code> because the return value of the generative function call at <code>"a"</code> flows into the generative function call at <code>"c"</code> - but we do not need to re-visit <code>"b"</code> because none of the values which flow into <code>"b"</code> have changed.</p>
<div class="page-columns page-full"><p>When computing the weight difference, unchanged sites thus contribute nothing.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;The important idea is that tracking what values have changed allows us to identify what parts of the computation graph are required - and what parts do not need to be re-visited or re-computed.</p></li></div></div>
</section>
</section>
<section id="change-information" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="change-information">Change information</h2>
<p>The specification of <code>update</code> doesn’t require that an implementation track or use the change information - but generative function implementations can choose to optimize their <code>update</code> implementation.</p>
<p>With that in mind, several of the languages which GenJAX exposes can be instructed to perform optimized <code>update</code> computations using <code>Diff</code> values.</p>
<p>A <code>Diff</code> value consists of a base value <code>v</code> and a value of <code>Change</code> type, which represents the change to the base value. The new argument value for <code>update</code> is given by <span class="math inline">\(\text{v} \oplus dv\)</span> where <code>dv :: Change</code>.</p>
<p>The <span class="math inline">\(\oplus\)</span> operation must be appropriately defined for the change type lattice - we implement this operation for common change types in GenJAX, but users can define their own change types for <code>Pytree</code> data classes.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>genjax.Diff.new(<span class="fl">5.0</span>, genjax.NoChange)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Diff</span>
├── val
│   └── (const) 5.0
└── change
    └── (const) &lt;genjax._src.core.diff_rules._NoChange object at 0x1468d9bd0&gt;
</pre>
</div>
</div>
<section id="diffs-for-distributions" class="level3">
<h3 class="anchored" data-anchor-id="diffs-for-distributions">Diffs for distributions</h3>
<p>Let’s explore the basics with distributions.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>key, dist_tr <span class="op">=</span> genjax.Normal.simulate(key, (<span class="fl">0.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dist_tr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">DistributionTrace</span>
├── gen_fn
│   └── <span style="font-weight: bold">_Normal</span>
├── args
│   └── <span style="font-weight: bold">tuple</span>
│       ├── (const) 0.0
│       └── (const) 1.0
├── value
│   └──  f32[]
└── score
    └──  f32[]
</pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dist_tr.update is equivalent to model.update(key, tr, ...)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>key, (ret_diff, w, tr, d) <span class="op">=</span> dist_tr.update(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    key,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    genjax.EmptyChoiceMap(),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        genjax.Diff.new(<span class="fl">1.0</span>, genjax.UnknownChange),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        genjax.Diff.new(<span class="fl">1.0</span>, genjax.NoChange),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The return values do not change.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(dist_tr.get_retval(), ret_diff.val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Array</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.72876865</span>, <span style="color: #808000; text-decoration-color: #808000">dtype</span>=<span style="color: #800080; text-decoration-color: #800080">float32</span><span style="font-weight: bold">)</span>, <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Array</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.72876865</span>, <span style="color: #808000; text-decoration-color: #808000">dtype</span>=<span style="color: #800080; text-decoration-color: #800080">float32</span><span style="font-weight: bold">))</span>
</pre>
</div>
</div>
<p>The weight is non-zero because the arguments have changed, implying that we must re-evaluate the log probability.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">Array</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.2287686</span>, <span style="color: #808000; text-decoration-color: #808000">dtype</span>=<span style="color: #800080; text-decoration-color: #800080">float32</span><span style="font-weight: bold">)</span>
</pre>
</div>
</div>
<p>What does the code look like when there is no new constraint and both the arguments do not change?</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dist_tr.update is equivalent to model.update(key, tr, ...)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>jaxpr <span class="op">=</span> jax.make_jaxpr(dist_tr.update)(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    key,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    genjax.EmptyChoiceMap(),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        genjax.Diff.new(<span class="fl">0.0</span>, genjax.NoChange),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        genjax.Diff.new(<span class="fl">1.0</span>, genjax.NoChange),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>jaxpr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span> <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">lambda </span><span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">a:f32</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">[]</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">b:f32</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">[]</span><span style="color: #000000; text-decoration-color: #000000">; c</span><span style="color: #800080; text-decoration-color: #800080">:u32</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">]</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">d:f32</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">[]</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">e:f32</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">[]</span><span style="color: #000000; text-decoration-color: #000000">. </span><span style="color: #000080; text-decoration-color: #000080; font-weight: bold">let</span>
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">    </span>
<span style="color: #000080; text-decoration-color: #000080; font-weight: bold">  in </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">(</span><span style="color: #000000; text-decoration-color: #000000">c, a, </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span><span style="color: #000000; text-decoration-color: #000000">, </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.0</span><span style="color: #000000; text-decoration-color: #000000">, </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.0</span><span style="color: #000000; text-decoration-color: #000000">, a, b, </span><span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span><span style="color: #000000; text-decoration-color: #000000">, a</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">)</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">}</span>
</pre>
</div>
</div>
<p>As expected, no computation is required - so the flattened arguments are just forwarded to the return.</p>
</section>
<section id="diff-propagation-in-the-builtingenerativefunction-language" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="diff-propagation-in-the-builtingenerativefunction-language">Diff propagation in the <code>BuiltinGenerativeFunction</code> language</h3>
<p>The builtin language exposes a new set of complexities.</p>
<p>Now, programs represent generative functions. If we were designing a compiler, we’d need to explore an analysis which tracks the dataflow of values, and determines how changes to values propagate. With this analysis, we can identify what call sites are affected by changes, and implement our optimizations accordingly.</p>
<p>This is a rough description of how you would implement change propagation and optimization in a traditional compiler. But with JAX, we can just write an interpreter to do the analysis and optimization for us. The interpreter will operate on values lifted to <code>Diff</code> types, with the set of change values defined by a lattice of change types.</p>
<div class="page-columns page-full"><p><a href="https://github.com/probcomp/genjax/blob/main/src/genjax/_src/core/propagate.py">This interpreter is the propagation interpreter.</a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> We won’t show the full complexity of this interpreter in the notebook - but we’ll briefly walk through some of the components.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;We discuss this interpreter in more detail in the <a href="../../advanced/impl_builtin_language/impl_builtin_language.ipynb">Implementing the builtin modeling language</a> notebook.</p></li></div></div>
<p>This interpreter operates on <code>Diff</code> values, and supports customization via propagation rules which can be provided to the interpreter.</p>
<section id="propagation-rules" class="level4">
<h4 class="anchored" data-anchor-id="propagation-rules">Propagation rules</h4>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>genjax.diff_propagation_rules</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/var/folders/mk/btkplz1n40q001dsy957srbh0000gn/T/ipykernel_80977/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">3278730948.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000; font-style: italic">[Errno 2] No such file or directory: </span>                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000; font-style: italic">'/var/folders/mk/btkplz1n40q001dsy957srbh0000gn/T/ipykernel_80977/3278730948.py'</span>                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">AttributeError: </span>module <span style="color: #008000; text-decoration-color: #008000">'genjax'</span> has no attribute <span style="color: #008000; text-decoration-color: #008000">'diff_propagation_rules'</span>
</pre>
</div>
</div>
<p>What is the <code>fallback_rule</code>? This rule is defined to operate on any primitive operation which is not explicitly key’d into the <code>rule_set</code>. In the <code>rule_set</code> for <code>Diff</code> propagation, we only provide overloads for special JAX operations - otherwise, the primitive uses the <code>fallback_rule</code> to attempt to propagate <code>Diff</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fallback_diff_rule(prim: Any, incells: List[Diff], outcells: Any, <span class="op">**</span>params):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(<span class="bu">map</span>(<span class="kw">lambda</span> v: v.top(), incells)):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        in_vals <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> v: v.get_val(), incells))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> prim.bind(<span class="op">*</span>in_vals, <span class="op">**</span>params)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">all</span>(<span class="bu">map</span>(<span class="kw">lambda</span> v: v.get_change() <span class="op">==</span> NoChange, incells)):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            new_out <span class="op">=</span> jtu.tree_map(<span class="kw">lambda</span> v: Diff.new(v, change<span class="op">=</span>NoChange), out)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            new_out <span class="op">=</span> jtu.tree_map(<span class="kw">lambda</span> v: Diff.new(v), out)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> prim.multiple_results:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            new_out <span class="op">=</span> [new_out]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        new_out <span class="op">=</span> outcells</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> incells, new_out, <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the <code>incells</code> define edges propagating into the primitive operation <code>prim</code> in the <code>Jaxpr</code> representation of our program.</p>
<p><code>v.top()</code> is a call to a method which returns information about the base value and the <code>Change</code> value in the <code>Diff</code> - the <code>Change</code> values are defined on a <code>Change</code> type lattice. For now, we’ll just consider two values: <code>NoChange</code> and <code>UnknownChange</code>.</p>
<p><code>v.top()</code> just checks to make sure that the base value is not <code>None</code> (e.g.&nbsp;propagation has succeeded in learning the type of this edge into the <code>prim</code> operation).</p>
<p>Propagation with this rule set ensures that once the type of the base value is known, so is the <code>Change</code> value.</p>
<p>If we know the base values of all <code>incells</code> edges, we can <code>bind</code> the primitive using the invals, and then decide how to propagate a new <code>Change</code> value out. If any of the incoming edge <code>Change</code> values are <code>UnknownChange</code> - we set all the outgoing edges to <code>UnknownChange</code> (that’s the default call to <code>Diff.new(...)</code>).</p>
</section>
<section id="what-about-trace" class="level4">
<h4 class="anchored" data-anchor-id="what-about-trace">What about <code>trace</code>?</h4>
<p>You may be wondering - is <code>genjax.trace</code> also handled by the <code>fallback_rule</code>? The answer is no.</p>
<p>The semantics of the generative function interface methods sometimes require that we record state during the interpretation of <code>genjax.trace</code>.</p>
<p>To support this pattern, we don’t handle <code>genjax.trace</code> with a rule from the rule set - we use a stateful handler (similar to an effect handler, but staged out at trace time) to provide overloads for <code>genjax.trace</code> (and <code>genjax.cache</code>).</p>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>When we say “stateful” here – you might be concerned about mutation, and JAX’s distaste for it. These stateful handlers don’t mutate JAX-owned values (tracers), so they’re compatible with JAX’s pure programming model.</p>
<p>The handlers provide a state monad-like local context during JAX tracing. This context models read and writes to state - but because we stage out the transformation, they are partially evaluated away during code generation, and they do not occur in our runtime modeling and inference code.</p>
<p>Now, there are restrictions in how we write these stateful handlers - we discuss this further in <a href="../../advanced/impl_builtin_language/impl_builtin_language.ipynb">Implementing the builtin modeling language</a>.</p>
</div>
</div>
</div>
</section>
<section id="applying-the-interpreter" class="level4">
<h4 class="anchored" data-anchor-id="applying-the-interpreter">Applying the interpreter</h4>
<p>Below, we show how we invoke the interpreter in the implementation of <code>update</code> for the <code>BuiltinGenerativeFunction</code> language.</p>
<p>There’s quite a bit of complexity here. If you want a further unpacking of this section, we recommend the <a href="../../advanced/impl_builtin_language/impl_builtin_language.ipynb">Implementing the builtin modeling language</a> notebook.</p>
<p>Just remember that this transformation is also staged out - so objects like the stateful <code>handler</code> are used to</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># `update_transform` implements the semantics of `update` using a program transformation.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_transform(source_fn, <span class="op">**</span>kwargs):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@functools.wraps</span>(source_fn)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _inner(key, previous_trace, constraints, argdiffs):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        vals <span class="op">=</span> jtu.tree_map(strip_diff, argdiffs, is_leaf<span class="op">=</span>check_is_diff)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        jaxpr, (_, _, out_tree) <span class="op">=</span> stage(source_fn)(<span class="op">*</span>vals, <span class="op">**</span>kwargs)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        jaxpr, consts <span class="op">=</span> jaxpr.jaxpr, jaxpr.literals</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpreter also accepts a stateful handler -</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this encapsulates any extra state that we wish to</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return out of the transformed function.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        handler <span class="op">=</span> Update.new(key, previous_trace, constraints)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The interpreter used as a context.</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We specify that the base type lattice for values</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># is `Diff`, and we also specify propagation rules.</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> PropagationInterpreter.new(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            Diff, diff_propagation_rules, handler</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        ) <span class="im">as</span> interpreter:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            flat_argdiffs, _ <span class="op">=</span> jtu.tree_flatten(argdiffs, is_leaf<span class="op">=</span>check_is_diff)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The interpreter iterates over the program `Jaxpr`,</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># applying the propagation rules, until a fixpoint</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># is reached.</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>            final_env, _ <span class="op">=</span> interpreter(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>                jaxpr,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>                [Diff.new(v, change<span class="op">=</span>NoChange) <span class="cf">for</span> v <span class="kw">in</span> consts],</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                flat_argdiffs,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                [Diff.unknown(var.aval) <span class="cf">for</span> var <span class="kw">in</span> jaxpr.outvars],</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We get the final retval values out of the environment.</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            flat_retval_diffs <span class="op">=</span> safe_map(final_env.read, jaxpr.outvars)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            retval_diffs <span class="op">=</span> jtu.tree_unflatten(</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                out_tree,</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                flat_retval_diffs,</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Now, we get the values which we must return from</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the generative function interface - these come from</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the stateful handler.</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            retvals <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(strip_diff, flat_retval_diffs))</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>            retvals <span class="op">=</span> jtu.tree_unflatten(out_tree, retvals)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> handler.weight</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>            constraints <span class="op">=</span> handler.choice_state</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>            cache <span class="op">=</span> handler.cache_state</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            discard <span class="op">=</span> handler.discard</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> handler.key</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return everything that `update` in `BuiltinGenerativeFunction`</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># needs to implement its specification.</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>            key,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>                retval_diffs,</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>                w,</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                (</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>                    source_fn,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                    vals,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                    retvals,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                    constraints,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>                    previous_trace.get_score() <span class="op">+</span> w,</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>                discard,</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>            cache,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _inner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combining-the-ingredients" class="level4">
<h4 class="anchored" data-anchor-id="combining-the-ingredients">Combining the ingredients</h4>
<p>Without digging into the implementation of this functionality, we can spot check that it’s working by examining a few example <code>update</code> computations.</p>
</section>
</section>
</section>
<section id="cache-change-aware-memoization" class="level2">
<h2 class="anchored" data-anchor-id="cache-change-aware-memoization"><code>cache</code>: change aware memoization</h2>
<p>The <code>BuiltinGenerativeFunction</code> language exposes a primitive called <code>cache</code> that interacts with the change tracking system to support memoization of deterministic computations (even deterministic computations which depend on random choices).</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../concepts/combinators/intro_to_combinators.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Generative function combinators</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../concepts/gradient_interfaces/gradient_interfaces.html" class="pagination-link">
        <span class="nav-page-text">Differentiable programming</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">© Copyright 2022 <a href="http://probcomp.csail.mit.edu/">MIT Probabilistic Computing Project</a></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="McCoy Reynolds Becker">
<meta name="dcterms.date" content="2023-12-03">

<title>Gen ⊗ JAX - Introduction to Gen and GenJAX</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../concepts/combinators/intro_to_combinators.html" rel="next">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta property="og:title" content="Gen ⊗ JAX - Introduction to Gen and GenJAX">
<meta property="og:description" content="This notebook is designed to give the reader an accelerated introduction to concepts native to trace-based probabilistic programming, Gen, and GenJAX (an implementation of Gen on top of JAX). For pre-requisites, the notebook assumes some familiarity with trace-based probabilistic programming systems, and Monte Carlo inference - especially importance sampling (although we describe concepts when we need them).">
<meta property="og:image" content="intro_to_genjax_files/figure-html/cell-16-output-2.svg">
<meta property="og:site-name" content="Gen ⊗ JAX">
</head>

<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../concepts/introduction/intro_to_genjax.html">Getting started</a></li><li class="breadcrumb-item"><a href="../../concepts/introduction/intro_to_genjax.html">Introduction</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="../../" rel="" title="Home" class="quarto-navigation-tool px-1" aria-label="Home"><i class="bi bi-house-heart"></i></a>
    <a href="http://probcomp.csail.mit.edu/" rel="" title="MIT Probabilistic Computing Project" class="quarto-navigation-tool px-1" aria-label="MIT Probabilistic Computing Project"><i class="bi bi-building"></i></a>
    <a href="https://github.com/probcomp/genjax" rel="" title="GitHub repository" class="quarto-navigation-tool px-1" aria-label="GitHub repository"><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/introduction/intro_to_genjax.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../concepts/combinators/intro_to_combinators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">(WIP) Generative function combinators</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Inference programming</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../intermediate/gaussian_processes/gaussian_processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">(WIP) Gaussian processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../advanced/gen_sp/gen_sp.ipynb" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>GenSP</code> (density estimates)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-genjax" id="toc-what-is-genjax" class="nav-link active" data-scroll-target="#what-is-genjax">What is GenJAX?</a></li>
  <li><a href="#what-is-probabilistic-programming" id="toc-what-is-probabilistic-programming" class="nav-link" data-scroll-target="#what-is-probabilistic-programming">What is probabilistic programming?</a>
  <ul class="collapse">
  <li><a href="#a-bayesian-viewpoint" id="toc-a-bayesian-viewpoint" class="nav-link" data-scroll-target="#a-bayesian-viewpoint">A Bayesian viewpoint</a></li>
  <li><a href="#what-are-we-actually-computing-with" id="toc-what-are-we-actually-computing-with" class="nav-link" data-scroll-target="#what-are-we-actually-computing-with">What are we actually computing with?</a></li>
  </ul></li>
  <li><a href="#what-is-a-generative-function" id="toc-what-is-a-generative-function" class="nav-link" data-scroll-target="#what-is-a-generative-function">What is a generative function?</a>
  <ul class="collapse">
  <li><a href="#how-is-simulate-implemented-for-this-language" id="toc-how-is-simulate-implemented-for-this-language" class="nav-link" data-scroll-target="#how-is-simulate-implemented-for-this-language">How is <code>simulate</code> implemented for this language?</a></li>
  </ul></li>
  <li><a href="#generative-function-interface" id="toc-generative-function-interface" class="nav-link" data-scroll-target="#generative-function-interface">Generative function interface</a>
  <ul class="collapse">
  <li><a href="#the-generative-function-interface-in-genjax" id="toc-the-generative-function-interface-in-genjax" class="nav-link" data-scroll-target="#the-generative-function-interface-in-genjax">The generative function interface in GenJAX</a></li>
  </ul></li>
  <li><a href="#more-about-generative-functions" id="toc-more-about-generative-functions" class="nav-link" data-scroll-target="#more-about-generative-functions">More about generative functions</a>
  <ul class="collapse">
  <li><a href="#distributions-are-generative-functions" id="toc-distributions-are-generative-functions" class="nav-link" data-scroll-target="#distributions-are-generative-functions">Distributions are generative functions</a></li>
  <li><a href="#associated-data-types" id="toc-associated-data-types" class="nav-link" data-scroll-target="#associated-data-types">Associated data types</a></li>
  </ul></li>
  <li><a href="#what-can-i-do-with-them" id="toc-what-can-i-do-with-them" class="nav-link" data-scroll-target="#what-can-i-do-with-them">What can I do with them?</a></li>
  <li><a href="#your-first-inference-program" id="toc-your-first-inference-program" class="nav-link" data-scroll-target="#your-first-inference-program">Your first inference program</a>
  <ul class="collapse">
  <li><a href="#importance-sampling-informally" id="toc-importance-sampling-informally" class="nav-link" data-scroll-target="#importance-sampling-informally">Importance sampling, informally</a></li>
  <li><a href="#back-to-our-generative-function" id="toc-back-to-our-generative-function" class="nav-link" data-scroll-target="#back-to-our-generative-function">Back to our generative function</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/probcomp/genjax/blob/main/concepts/introduction/intro_to_genjax.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/probcomp/genjax/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Introduction to Gen and GenJAX</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>McCoy Reynolds Becker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 3, 2023</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    This notebook is designed to give the reader an accelerated introduction to concepts native to trace-based probabilistic programming, Gen, and GenJAX (an implementation of Gen on top of JAX). For pre-requisites, the notebook assumes some familiarity with trace-based probabilistic programming systems, and Monte Carlo inference - especially importance sampling (although we describe concepts when we need them).
  </div>
</div>

</header>

<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:14.410076Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:14.399812Z&quot;}" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'svg'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:15.040941Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:15.028474Z&quot;}" data-tags="[]" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.tree_util <span class="im">as</span> jtu</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> genjax</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> genjax <span class="im">import</span> lang, Static</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> genjax <span class="im">import</span> GenerativeFunction, ChoiceMap, Selection, trace</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty printing.</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>console <span class="op">=</span> genjax.console(enforce_checkify<span class="op">=</span><span class="va">True</span>, width<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproducibility.</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> jax.random.PRNGKey(<span class="dv">314159</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="what-is-genjax" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-is-genjax">What is GenJAX?</h2>
<p>Here are a few high-level ways to think about GenJAX:</p>
<ul>
<li><p>A probabilistic programming<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> system based on the concepts of <a href="https://www.gen.dev/">Gen</a>.</p></li>
<li><p>A Bayesian modelling and inference compiler with support for device acceleration (courtesy of JAX).</p></li>
<li><p>A base layer for experiments in model and inference DSL design.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;New to probabilistic programming? <a href="#what-is-probabilistic-programming">Don’t fret, read on!</a></p></li></div><p>There’s already a well-supported implementation of <a href="https://github.com/probcomp/Gen.jl">Gen in Julia</a>. Why is a JAX port interesting?</p>
<p>There are a number of compelling technical and social reasons to explore Gen’s probabilistic programming paradigm on top of JAX, here are a few:</p>
<ul>
<li><p>JAX’s excellent accelerator support - our implementation natively supports several common accelerator idioms - like automatic struct-of-array representations, and the ability to automatically batch model/inference programs onto accelerators.</p></li>
<li><p>JAX’s excellent support for compositional AD removes implementation and maintenance complexity for Gen’s gradient interfaces - previously a difficult challenge in other implementations. In addition, JAX’s support for convenient, higher-order AD opens up new opportunities to explore during inference design with gradient interfaces.</p></li>
<li><p>JAX exposes compositional code transformations to library authors, and, as library authors, we can utilize code transformations to implement state-of-the-art optimizations for models and inference expressed in our system.</p></li>
<li><p>A lot of domain experts and modelers are working in Python! Some of them even use JAX (hopefully more each year). Presenting an interface to Gen which is familiar, and takes advantage of JAX’s native ecosystem is a compelling social reason.</p></li>
</ul>
<p>Let’s truncate the list there for now.</p>
<p>For the JAX literati, one final (hopefully tantalizing) takeaway: <u>by construction, all GenJAX modeling + inference code is JAX traceable</u> - and thus, <code>vmap</code>able, <code>jit</code>able, etc.</p>
</section>
<section id="what-is-probabilistic-programming" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-is-probabilistic-programming">What is probabilistic programming?</h2>
<p>Perhaps you may be coming to this notebook without any prior knowledge in probabilistic programming…</p>
<div class="page-columns page-full"><p>That’s okay! Ideally, the ideas in this notebook should be self-contained<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;You may miss <em>why generative functions (see below) are designed the way they are</em> on a first read - but you’ll still get the punchline if you follow the notebook to the end.</p></li></div></div>
<section id="a-bayesian-viewpoint" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="a-bayesian-viewpoint">A Bayesian viewpoint</h3>
<div class="page-columns page-full"><p>Here’s one practical take on what probabilistic programming is all about: programming language design for expressing and solving Bayesian inference problems<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;In the <a href="http://probcomp.csail.mit.edu/">Probabilistic Computing lab at MIT</a>, we also consider differentiable programming to be contained within the set of concerns of probabilistic programming. We won’t cover differentiable programming interfaces in this notebook.</p></li></div></div>
<p>Probabilistic programming is a broad field, and there are corners which may not be covered by this practical take. We’ll just assume that people are interested in Bayes, and how to represent Bayes on computers in nice ways. For our purposes in this notebook, we’ll stick as much as we can to the basics.</p>
</section>
<section id="what-are-we-actually-computing-with" class="level3">
<h3 class="anchored" data-anchor-id="what-are-we-actually-computing-with">What are we actually computing with?</h3>
<p>The objects which we program with expose a mixture of generative and differentiable interfaces - the interfaces are designed to support common (as well as quite advanced) classes of Bayesian inference algorithms. Gen provides automation for the tricky math which these algorithms require.</p>
<p>We separate the design of inference (whose implementation uses the interfaces), from the implementation of the interfaces on computational objects. This allows us to build languages of objects which satisfy the interfaces - and allows their compositional usage and interoperability.</p>
<p>In Gen, the objects which implement the interfaces are called <strong>generative functions</strong>.</p>
</section>
</section>
<section id="what-is-a-generative-function" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-is-a-generative-function">What is a generative function?</h2>
<p>Generative functions are the key concept of Gen’s probabilistic programming paradigm. Generative functions are computational objects defined by a set of associated data types and methods. These types and methods describe compositional interfaces that are useful for Bayesian inference computations.</p>
<p>Gen’s formal description of generative functions consist of two objects:</p>
<ul>
<li><p><span class="math inline">\(P(\tau, r; x)\)</span> - a normalized measure over tree-like data (<em>choice maps</em>) and untraced randomness<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> <span class="math inline">\(r\)</span>, parametrized by arguments <span class="math inline">\(x\)</span>.</p></li>
<li><p><span class="math inline">\(f(\tau; x)\)</span> - a deterministic function from the above measure’s sample space to a space of data types.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;More on this later. It’s safe to say “I have no idea what that is” for now, and expect us to explain later or in another notebook.</p></li></div><p>We can informally think of the sampling semantics of these objects as consisting of two steps:</p>
<ol type="1">
<li>First, sample a choice map from <span class="math inline">\(P\)</span>.</li>
<li>Then, compute the return value using <span class="math inline">\(f\)</span>.</li>
</ol>
<p>In many of the generative function interfaces, we won’t just be interested in the final sampled return value. We’ll also be interested in what happened along the way: we’ll record the intermediate and final results of these steps in <code>Trace</code> objects - data structures which contain the recordings of values, along with probabilistic metadata like the score of random choices selected along the way.</p>
<div class="page-columns page-full"><p>Below, we provide an example of an (admittedly, not too interesting) GenJAX generative function<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn5"><p><sup>5</sup>&nbsp;There’s not just one generative function class - users can and are encouraged to design new types of generative functions which capture repeated modeling patterns. An excellent example of this modularity in Gen’s design is <a href="../../introduction/intro_to_combinators/intro_to_combinators">generative function combinators</a>.</p></li></div></div>
<p>This generative function is part of a function-like language (the <code>BuiltinGenerativeFunction</code> language) - pay close attention to the hierarchical compositionality of generative functions in this language under an abstraction (<code>genjax.trace</code>) similar to a function call. We’ll discuss the addresses (<code>"sub"</code> and <code>"m0"</code>) a bit later.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:19.996056Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:19.971270Z&quot;}" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> g(x):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    m0 <span class="op">=</span> genjax.trace(<span class="st">"m0"</span>, genjax.bernoulli)(x)  <span class="co"># unsweetened</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m0</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> h(x):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    m0 <span class="op">=</span> g(x) <span class="op">@</span> <span class="st">"sub"</span>  <span class="co"># sweetened</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m0</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>StaticGenerativeFunction(source=&lt;function h at 0x16d1f4e00&gt;)</code></pre>
</div>
</div>
<p>This generative function holds a Python <code>Callable</code> object. For this generative function language, the interface methods (see the list under <strong>Generative function interface</strong> below) which are useful for modeling and inference are given semantics via JAX’s tracing and program transformation infrastructure.</p>
<p>Let’s examine some of these operations now.</p>
<p>This is our first glimpse of the <strong>generative function interface</strong> (GFI), the secret sauce which Gen is based around.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
JAX interfaces
</div>
</div>
<div class="callout-body-container callout-body">
<p>There’s a few methods which you might see which are not explicitly part of Gen’s GFI, but are worth mentioning because they deal with data interfaces to JAX:</p>
<ul>
<li><code>flatten</code> - which allows us to treat generative functions as <a href="https://jax.readthedocs.io/en/latest/pytrees.html">Pytree</a> implementors.</li>
<li><code>unflatten</code> - same as above.</li>
</ul>
<p>These are used to register the implementor type as a <code>Pytree</code>, which is roughly a tree-like Python structure which JAX can zip/unzip at runtime API boundaries.</p>
</div>
</div>
<p>Let’s study the <code>simulate</code> method first: we’ll explore its semantics, and see the types of data it produces.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:23.247857Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:23.222576Z&quot;}" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>key</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Array([     0, 314159], dtype=uint32)</code></pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:25.213067Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:25.146778Z&quot;}" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> h.simulate(sub_key, (<span class="fl">0.3</span>,))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>console.<span class="bu">print</span>(tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">StaticTrace</span>
├── gen_fn
│   └── <span style="font-weight: bold">StaticGenerativeFunction</span>
│       └── source
│           └── &lt;function h&gt;
├── args
│   └── <span style="font-weight: bold">tuple</span>
│       └── (const) 0.3
├── retval
│   └──  i32[]
├── address_choices
│   └── <span style="font-weight: bold">Trie</span>
│       └── <span style="font-weight: bold">:sub</span>
│           └── <span style="font-weight: bold">StaticTrace</span>
│               ├── gen_fn
│               │   └── <span style="font-weight: bold">StaticGenerativeFunction</span>
│               │       └── source
│               │           └── &lt;function g&gt;
│               ├── args
│               │   └── <span style="font-weight: bold">tuple</span>
│               │       └── (const) 0.3
│               ├── retval
│               │   └──  i32[]
│               ├── address_choices
│               │   └── <span style="font-weight: bold">Trie</span>
│               │       └── <span style="font-weight: bold">:m0</span>
│               │           └── <span style="font-weight: bold">DistributionTrace</span>
│               │               ├── gen_fn
│               │               │   └── <span style="font-weight: bold">TFPDistribution</span>
│               │               │       └── make_distribution
│               │               │           └── &lt;function &lt;lambda&gt;&gt;
│               │               ├── args
│               │               │   └── <span style="font-weight: bold">tuple</span>
│               │               │       └── (const) 0.3
│               │               ├── value
│               │               │   └──  i32[]
│               │               └── score
│               │                   └──  f32[]
│               ├── cache
│               │   └── <span style="font-weight: bold">Trie</span>
│               └── score
│                   └──  f32[]
├── cache
│   └── <span style="font-weight: bold">Trie</span>
└── score
    └──  f32[]
</pre>
</div>
</div>
<p>If you’re familiar with other “trace-based” probabilistic systems - this should look familiar.</p>
<p>This object instance is a piece of data which has captured information about the execution of the function. Specifically, the subtraces of <em>other generative function calls</em> which occur in <code>genjax.trace</code> statements.</p>
<p>It also captures the <code>score</code> - the log probability of the normalized measure which the model program represents, evaluated at the random choices which the generative call execution produced.</p>
<p>If you were paying attention above, the score is <span class="math inline">\(\log P(\tau, r; x)\)</span>.</p>
<section id="how-is-simulate-implemented-for-this-language" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="how-is-simulate-implemented-for-this-language">How is <code>simulate</code> implemented for this language?</h3>
<p>For this generative function language, we implement <code>simulate</code> using a code transformation! Here’s the transformed code.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:30.862951Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:30.853877Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>jaxpr <span class="op">=</span> jax.make_jaxpr(h.simulate)(key, (<span class="fl">0.3</span>,))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>jaxpr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div class="ansi-escaped-output">
<pre>{ <span class="ansi-blue-fg ansi-bold">lambda </span>; a<span class="ansi-magenta-fg">:u32[2]</span> b<span class="ansi-magenta-fg">:f32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>    c<span class="ansi-magenta-fg">:key&lt;fry&gt;[]</span> = random_wrap[impl=fry] a
    d<span class="ansi-magenta-fg">:key&lt;fry&gt;[2]</span> = random_split[shape=(2,)] c
    e<span class="ansi-magenta-fg">:u32[2,2]</span> = random_unwrap d
    f<span class="ansi-magenta-fg">:u32[1,2]</span> = slice[limit_indices=(1, 2) start_indices=(0, 0) strides=(1, 1)] e
    _<span class="ansi-magenta-fg">:u32[2]</span> = squeeze[dimensions=(0,)] f
    g<span class="ansi-magenta-fg">:u32[1,2]</span> = slice[limit_indices=(2, 2) start_indices=(1, 0) strides=(1, 1)] e
    h<span class="ansi-magenta-fg">:u32[2]</span> = squeeze[dimensions=(0,)] g
    i<span class="ansi-magenta-fg">:key&lt;fry&gt;[]</span> = random_wrap[impl=fry] h
    j<span class="ansi-magenta-fg">:key&lt;fry&gt;[2]</span> = random_split[shape=(2,)] i
    k<span class="ansi-magenta-fg">:u32[2,2]</span> = random_unwrap j
    l<span class="ansi-magenta-fg">:u32[1,2]</span> = slice[limit_indices=(1, 2) start_indices=(0, 0) strides=(1, 1)] k
    _<span class="ansi-magenta-fg">:u32[2]</span> = squeeze[dimensions=(0,)] l
    m<span class="ansi-magenta-fg">:u32[1,2]</span> = slice[limit_indices=(2, 2) start_indices=(1, 0) strides=(1, 1)] k
    n<span class="ansi-magenta-fg">:u32[2]</span> = squeeze[dimensions=(0,)] m
    o<span class="ansi-magenta-fg">:f32[]</span> = logistic b
    p<span class="ansi-magenta-fg">:f32[1]</span> = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] 0.0
    q<span class="ansi-magenta-fg">:f32[1]</span> = add 0.0 p
    r<span class="ansi-magenta-fg">:f32[1]</span> = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] 0.0
    s<span class="ansi-magenta-fg">:f32[1]</span> = add 1.0 r
    t<span class="ansi-magenta-fg">:key&lt;fry&gt;[]</span> = random_wrap[impl=fry] n
    u<span class="ansi-magenta-fg">:f32[1]</span> = pjit[
      jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; v<span class="ansi-magenta-fg">:key&lt;fry&gt;[]</span> w<span class="ansi-magenta-fg">:f32[1]</span> x<span class="ansi-magenta-fg">:f32[1]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>          y<span class="ansi-magenta-fg">:u32[1]</span> = random_bits[bit_width=32 shape=(1,)] v
          z<span class="ansi-magenta-fg">:u32[1]</span> = shift_right_logical y 9
          ba<span class="ansi-magenta-fg">:u32[1]</span> = or z 1065353216
          bb<span class="ansi-magenta-fg">:f32[1]</span> = bitcast_convert_type[new_dtype=float32] ba
          bc<span class="ansi-magenta-fg">:f32[1]</span> = sub bb 1.0
          bd<span class="ansi-magenta-fg">:f32[1]</span> = sub x w
          be<span class="ansi-magenta-fg">:f32[1]</span> = mul bc bd
          bf<span class="ansi-magenta-fg">:f32[1]</span> = add be w
          bg<span class="ansi-magenta-fg">:f32[1]</span> = max w bf
        <span class="ansi-blue-fg ansi-bold">in </span>(bg,) }
      name=_uniform
    ] t q s
    bh<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[new_dtype=float32 weak_type=False] o
    bi<span class="ansi-magenta-fg">:bool[1]</span> = lt u bh
    bj<span class="ansi-magenta-fg">:i32[1]</span> = convert_element_type[new_dtype=int32 weak_type=False] bi
    bk<span class="ansi-magenta-fg">:i32[]</span> = reshape[dimensions=None new_sizes=()] bj
    bl<span class="ansi-magenta-fg">:f32[]</span> = pjit[
      jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; bm<span class="ansi-magenta-fg">:f32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>          bn<span class="ansi-magenta-fg">:f32[]</span> = custom_jvp_call[
            call_jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; bo<span class="ansi-magenta-fg">:f32[]</span> bp<span class="ansi-magenta-fg">:i32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>                bq<span class="ansi-magenta-fg">:f32[]</span> = pjit[
                  jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; br<span class="ansi-magenta-fg">:f32[]</span> bs<span class="ansi-magenta-fg">:i32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>                      bt<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[
                        new_dtype=float32
                        weak_type=True
                      ] bs
                      bu<span class="ansi-magenta-fg">:f32[]</span> = max br bt
                      bv<span class="ansi-magenta-fg">:f32[]</span> = sub br bt
                      bw<span class="ansi-magenta-fg">:bool[]</span> = ne bv bv
                      bx<span class="ansi-magenta-fg">:f32[]</span> = add br bt
                      by<span class="ansi-magenta-fg">:f32[]</span> = abs bv
                      bz<span class="ansi-magenta-fg">:f32[]</span> = neg by
                      ca<span class="ansi-magenta-fg">:f32[]</span> = exp bz
                      cb<span class="ansi-magenta-fg">:f32[]</span> = log1p ca
                      cc<span class="ansi-magenta-fg">:f32[]</span> = add bu cb
                      cd<span class="ansi-magenta-fg">:f32[]</span> = select_n bw cc bx
                    <span class="ansi-blue-fg ansi-bold">in </span>(cd,) }
                  name=logaddexp
                ] bo bp
              <span class="ansi-blue-fg ansi-bold">in </span>(bq,) }
            jvp_jaxpr_thunk=&lt;function _memoize.&lt;locals&gt;.memoized at 0x16d4c28e0&gt;
            num_consts=0
            symbolic_zeros=False
          ] bm 0
        <span class="ansi-blue-fg ansi-bold">in </span>(bn,) }
      name=softplus
    ] b
    ce<span class="ansi-magenta-fg">:f32[]</span> = neg bl
    cf<span class="ansi-magenta-fg">:f32[]</span> = neg b
    cg<span class="ansi-magenta-fg">:f32[]</span> = pjit[
      jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; bm<span class="ansi-magenta-fg">:f32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>          bn<span class="ansi-magenta-fg">:f32[]</span> = custom_jvp_call[
            call_jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; bo<span class="ansi-magenta-fg">:f32[]</span> bp<span class="ansi-magenta-fg">:i32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>                bq<span class="ansi-magenta-fg">:f32[]</span> = pjit[
                  jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; br<span class="ansi-magenta-fg">:f32[]</span> bs<span class="ansi-magenta-fg">:i32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>                      bt<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[
                        new_dtype=float32
                        weak_type=True
                      ] bs
                      bu<span class="ansi-magenta-fg">:f32[]</span> = max br bt
                      bv<span class="ansi-magenta-fg">:f32[]</span> = sub br bt
                      bw<span class="ansi-magenta-fg">:bool[]</span> = ne bv bv
                      bx<span class="ansi-magenta-fg">:f32[]</span> = add br bt
                      by<span class="ansi-magenta-fg">:f32[]</span> = abs bv
                      bz<span class="ansi-magenta-fg">:f32[]</span> = neg by
                      ca<span class="ansi-magenta-fg">:f32[]</span> = exp bz
                      cb<span class="ansi-magenta-fg">:f32[]</span> = log1p ca
                      cc<span class="ansi-magenta-fg">:f32[]</span> = add bu cb
                      cd<span class="ansi-magenta-fg">:f32[]</span> = select_n bw cc bx
                    <span class="ansi-blue-fg ansi-bold">in </span>(cd,) }
                  name=logaddexp
                ] bo bp
              <span class="ansi-blue-fg ansi-bold">in </span>(bq,) }
            jvp_jaxpr_thunk=&lt;function _memoize.&lt;locals&gt;.memoized at 0x16d4c28e0&gt;
            num_consts=0
            symbolic_zeros=False
          ] bm 0
        <span class="ansi-blue-fg ansi-bold">in </span>(bn,) }
      name=softplus
    ] cf
    ch<span class="ansi-magenta-fg">:f32[]</span> = neg cg
    ci<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[new_dtype=float32 weak_type=False] bk
    cj<span class="ansi-magenta-fg">:f32[]</span> = sub 1.0 ci
    ck<span class="ansi-magenta-fg">:bool[]</span> = eq cj 0.0
    cl<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[new_dtype=float32 weak_type=False] ce
    cm<span class="ansi-magenta-fg">:f32[]</span> = mul cl cj
    cn<span class="ansi-magenta-fg">:f32[]</span> = pjit[
      jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; co<span class="ansi-magenta-fg">:bool[]</span> cp<span class="ansi-magenta-fg">:f32[]</span> cq<span class="ansi-magenta-fg">:f32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>          cr<span class="ansi-magenta-fg">:f32[]</span> = select_n co cq cp
        <span class="ansi-blue-fg ansi-bold">in </span>(cr,) }
      name=_where
    ] ck 0.0 cm
    cs<span class="ansi-magenta-fg">:bool[]</span> = eq ci 0.0
    ct<span class="ansi-magenta-fg">:f32[]</span> = convert_element_type[new_dtype=float32 weak_type=False] ch
    cu<span class="ansi-magenta-fg">:f32[]</span> = mul ct ci
    cv<span class="ansi-magenta-fg">:f32[]</span> = pjit[
      jaxpr={ <span class="ansi-blue-fg ansi-bold">lambda </span>; co<span class="ansi-magenta-fg">:bool[]</span> cp<span class="ansi-magenta-fg">:f32[]</span> cq<span class="ansi-magenta-fg">:f32[]</span>. <span class="ansi-blue-fg ansi-bold">let
</span>          cr<span class="ansi-magenta-fg">:f32[]</span> = select_n co cq cp
        <span class="ansi-blue-fg ansi-bold">in </span>(cr,) }
      name=_where
    ] cs 0.0 cu
    cw<span class="ansi-magenta-fg">:f32[]</span> = add cn cv
    cx<span class="ansi-magenta-fg">:f32[]</span> = add 0.0 cw
    cy<span class="ansi-magenta-fg">:f32[]</span> = add 0.0 cx
  <span class="ansi-blue-fg ansi-bold">in </span>(b, bk, b, bk, b, bk, cw, cx, cy) }</pre>
</div>
</div>
</div>
<p>That’s a lot of code! This code is pure, numerical, and ready for acceleration. By utilizing JAX and a staging transformation, we’ve stripped out all Python overhead.</p>
<div class="page-columns page-full"><p>This is how we’ve implemented <code>simulate</code> for this particular generative function language.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn6"><p><sup>6</sup>&nbsp;In general, Gen doesn’t require that we follow the same “JAX code transformation” implementation for other generative function languages. The relationship with JAX in GenJAX, however, is a bit special - often, we assume that the user is working within the JAX traceable subset of Python - hence, generative function interface implementations which are JAX traceable benefit from composition with other JAX compatible modeling structures.</p></li></div></div>
</section>
</section>
<section id="generative-function-interface" class="level2">
<h2 class="anchored" data-anchor-id="generative-function-interface">Generative function interface</h2>
<p>There are a few more generative function interface methods worth discussing.</p>
<p>In this notebook, instead of carefully walking through the math which these interface methods compute, we’ll defer that discussion to another notebook. Below, we give an informal discussion of what each of the interface methods computes, and roughly describe what algorithm families are supported by their usage.</p>
<section id="the-generative-function-interface-in-genjax" class="level3">
<h3 class="anchored" data-anchor-id="the-generative-function-interface-in-genjax">The generative function interface in GenJAX</h3>
<p>GenJAX’s generative functions define an interface which support compositional usage of generative functions within other generative functions. The interface functions here closely mirror <a href="https://www.gen.dev/docs/stable/ref/gfi/#Generative-function-interface-1">the interfaces defined in Gen.jl</a>.</p>
<p>In the following, we use the following abbreviations:</p>
<ul>
<li><strong>IS</strong> - importance sampling</li>
<li><strong>SMC</strong> - sequential Monte Carlo</li>
<li><strong>MCMC</strong> - Markov chain Monte Carlo</li>
<li><strong>VI</strong> - variational inference</li>
</ul>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Interface</th>
<th>Type</th>
<th>Inference algorithm support</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>simulate</code></td>
<td>Generative</td>
<td>IS, SMC</td>
</tr>
<tr class="even">
<td><code>importance</code></td>
<td>Generative</td>
<td>IS, SMC, VI</td>
</tr>
<tr class="odd">
<td><code>update</code></td>
<td>Generative and incremental</td>
<td>MCMC, SMC</td>
</tr>
<tr class="even">
<td><code>assess</code></td>
<td>Generative and differentiable</td>
<td>MCMC, IS, SMC</td>
</tr>
<tr class="odd">
<td><code>unzip</code></td>
<td>Differentiable</td>
<td>Differentiable and involutive MCMC and SMC, VI</td>
</tr>
</tbody>
</table>
<p>This interface supports several methods - I’ve roughly described them and split them into the two categories <strong>Generative</strong> and <strong>Differentiable</strong> below:</p>
<section id="generative" class="level4">
<h4 class="anchored" data-anchor-id="generative">Generative</h4>
<ul>
<li><code>simulate</code> - sample from normalized trace measure, and return the score.</li>
<li><code>importance</code> - given constraints for some addresses, sample from unnormalized trace measure and return an importance weight.</li>
<li><code>update</code> - given an existing trace, and a set of constraints and argument change values, update the trace to be consistent with the set of constraints under execution with the new arguments, and return an incremental importance weight.</li>
<li><code>assess</code> - given a complete choice map and arguments, return the normalized log probability.</li>
</ul>
</section>
<section id="differentiable" class="level4">
<h4 class="anchored" data-anchor-id="differentiable">Differentiable</h4>
<ul>
<li><code>assess</code> - same as above.</li>
<li><code>unzip</code> - given a set of fixed constraints, return two callables. The first callable <code>score</code> accepts constraints which fill in the complement of the fixed constraints and arguments, and returns the normalized log probability of all the constraints. The second callable <code>retval</code> accepts constraints and arguments, and returns the return value for the generative function call consistent with the constraints and given arguments.</li>
</ul>
<p><strong>unzip</strong> produces two functions which can be compositionally used with <code>jax.grad</code> to evaluate gradients used by both differentiable and involutive MCMC and SMC.</p>
</section>
</section>
</section>
<section id="more-about-generative-functions" class="level2">
<h2 class="anchored" data-anchor-id="more-about-generative-functions">More about generative functions</h2>
<p>Here are a few more bits of information which should help you gain context with these objects.</p>
<section id="distributions-are-generative-functions" class="level3">
<h3 class="anchored" data-anchor-id="distributions-are-generative-functions">Distributions are generative functions</h3>
<p>In GenJAX, distributions are generative functions.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:40.509680Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:40.437531Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> genjax.normal.simulate(sub_key, (<span class="fl">0.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>tr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>DistributionTrace(gen_fn=TFPDistribution(make_distribution=&lt;class 'tensorflow_probability.substrates.jax.distributions.normal.Normal'&gt;), args=(0.0, 1.0), value=Array(0.27442896, dtype=float32), score=Array(-0.95659417, dtype=float32))</code></pre>
</div>
</div>
<p>This should bring a sigh of relief! Ah, distributions are generative functions - <em>the concepts can’t be too exotic</em>.</p>
<p>Distributions implement the interface in a conceptually simple way. They don’t have internal compositional choice structure (like the function-like <code>BuiltinGenerativeFunction</code> language above).</p>
<p>Distributions themselves expose two interfaces:</p>
<ul>
<li><code>logpdf</code> - exact density evaluation.</li>
<li><code>sample</code> - exact sampling.</li>
</ul>
<p>We can use these two interfaces to implement all the generative function interfaces for distributions.</p>
</section>
<section id="associated-data-types" class="level3">
<h3 class="anchored" data-anchor-id="associated-data-types">Associated data types</h3>
<ul>
<li><strong>Choice maps</strong> are the tree-like representations of the values sampled at random choices inside of generative functions.</li>
<li><strong>Selections</strong> are objects which allows querying a trace/choice map - filtering certain choices, projecting joint log score computations onto address contributions, even manipulating choice maps. For those familiar with functional programming - they present a lens-like interface on choice maps.</li>
</ul>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:42.079031Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:42.032661Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> h(x):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    m1 <span class="op">=</span> genjax.bernoulli(x) <span class="op">@</span> <span class="st">"m0"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    m2 <span class="op">=</span> genjax.bernoulli(x) <span class="op">@</span> <span class="st">"m1"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m1 <span class="op">+</span> m2</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> h.simulate(sub_key, (<span class="fl">0.3</span>,))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>console.<span class="bu">print</span>(tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">StaticTrace</span>
├── gen_fn
│   └── <span style="font-weight: bold">StaticGenerativeFunction</span>
│       └── source
│           └── &lt;function h&gt;
├── args
│   └── <span style="font-weight: bold">tuple</span>
│       └── (const) 0.3
├── retval
│   └──  i32[]
├── address_choices
│   └── <span style="font-weight: bold">Trie</span>
│       ├── <span style="font-weight: bold">:m0</span>
│       │   └── <span style="font-weight: bold">DistributionTrace</span>
│       │       ├── gen_fn
│       │       │   └── <span style="font-weight: bold">TFPDistribution</span>
│       │       │       └── make_distribution
│       │       │           └── &lt;function &lt;lambda&gt;&gt;
│       │       ├── args
│       │       │   └── <span style="font-weight: bold">tuple</span>
│       │       │       └── (const) 0.3
│       │       ├── value
│       │       │   └──  i32[]
│       │       └── score
│       │           └──  f32[]
│       └── <span style="font-weight: bold">:m1</span>
│           └── <span style="font-weight: bold">DistributionTrace</span>
│               ├── gen_fn
│               │   └── <span style="font-weight: bold">TFPDistribution</span>
│               │       └── make_distribution
│               │           └── &lt;function &lt;lambda&gt;&gt;
│               ├── args
│               │   └── <span style="font-weight: bold">tuple</span>
│               │       └── (const) 0.3
│               ├── value
│               │   └──  i32[]
│               └── score
│                   └──  f32[]
├── cache
│   └── <span style="font-weight: bold">Trie</span>
└── score
    └──  f32[]
</pre>
</div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:42.905235Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:42.870604Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>selection <span class="op">=</span> genjax.select(<span class="st">"m1"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>selected <span class="op">=</span> tr.get_choices().<span class="bu">filter</span>(selection)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>selected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>HierarchicalChoiceMap(trie=Trie(inner={'m1': ChoiceValue(value=Array(1, dtype=int32))}))</code></pre>
</div>
</div>
</section>
</section>
<section id="what-can-i-do-with-them" class="level2">
<h2 class="anchored" data-anchor-id="what-can-i-do-with-them">What can I do with them?</h2>
<p>Now, we’ve informally seen the interfaces and datatypes associated with generative functions.</p>
<p>Studying the interfaces (and improvements thereof), as well as the computational objects which satisfy them can be an entire PhD’s worth of effort.</p>
<p>In the remainder of this notebook, let’s see how we can do machine learning with them.</p>
<p>Let’s consider a modeling problem where we wish to perform generalized regression with outliers between two variates, taking a family of polynomials as potential curves.</p>
<p>One such model for this data generating process is shown below.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:46.960745Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:46.920110Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two branches for a branching submodel.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_y(x, coefficients):</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    basis_value <span class="op">=</span> jnp.array([<span class="fl">1.0</span>, x, x<span class="op">**</span><span class="dv">2</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    polynomial_value <span class="op">=</span> jnp.<span class="bu">sum</span>(basis_value <span class="op">*</span> coefficients)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> genjax.normal(polynomial_value, <span class="fl">0.3</span>) <span class="op">@</span> <span class="st">"value"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outlier_model(x, coefficients):</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    basis_value <span class="op">=</span> jnp.array([<span class="fl">1.0</span>, x, x<span class="op">**</span><span class="dv">2</span>])</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    polynomial_value <span class="op">=</span> jnp.<span class="bu">sum</span>(basis_value <span class="op">*</span> coefficients)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> genjax.normal(polynomial_value, <span class="fl">30.0</span>) <span class="op">@</span> <span class="st">"value"</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># The branching submodel.</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>switch <span class="op">=</span> genjax.Switch(model_y, outlier_model)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># A mapped kernel function which calls the branching submodel.</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="at">@genjax.Map</span>(in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kernel(x, coefficients):</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    is_outlier <span class="op">=</span> genjax.flip(<span class="fl">0.1</span>) <span class="op">@</span> <span class="st">"outlier"</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> switch(is_outlier, x, coefficients) <span class="op">@</span> <span class="st">"y"</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="at">@Static</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(xs):</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    coefficients <span class="op">=</span> (</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        genjax.mv_normal(np.zeros(<span class="dv">3</span>, dtype<span class="op">=</span><span class="bu">float</span>), <span class="fl">2.0</span> <span class="op">*</span> np.identity(<span class="dv">3</span>, dtype<span class="op">=</span><span class="bu">float</span>))</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">@</span> <span class="st">"alpha"</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> kernel(xs, coefficients) <span class="op">@</span> <span class="st">"ys"</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s a few implementation patterns which you might pick up on by studying this model.</p>
<ol type="1">
<li><p>To implement control flow, we use higher-order functions called combinators. These accept generative functions as input, and return generative functions as output.</p></li>
<li><p>Any JAX compatible code is allowed in the body of a generative function.</p></li>
</ol>
<p>Courtesy of the interface, we get to design our <code>model</code> generative function in pieces.</p>
<p>Now, let’s examine the sampled observation address <code>("ys", "y")</code> from a sample trace from our model.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:49.771528Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:48.546399Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> jnp.arange(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.5</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> jax.jit(model.simulate)(sub_key, (data,))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>tr.strip()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/jax/_src/numpy/array_methods.py:64: UserWarning: Explicitly requested dtype &lt;class 'numpy.float64'&gt; requested in astype is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  return lax_numpy.astype(arr, dtype)
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/jax/_src/numpy/array_methods.py:64: UserWarning: Explicitly requested dtype float64 requested in astype is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  return lax_numpy.astype(arr, dtype)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>HierarchicalChoiceMap(trie=Trie(inner={'ys': VectorChoiceMap(inner=HierarchicalChoiceMap(trie=Trie(inner={'outlier': ChoiceValue(value=Array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], dtype=int32)), 'y': SwitchChoiceMap(index=Array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], dtype=int32), submaps=[HierarchicalChoiceMap(trie=Trie(inner={'value': ChoiceValue(value=Array([ -0.29988667,   1.9623835 ,   4.338261  ,   8.128784  ,
        12.602457  ,  18.124142  ,  24.348125  ,  31.462566  ,
        40.482452  ,  49.124428  ,  59.449287  ,  70.73518   ,
        83.24687   ,  96.03866   , 109.91974   , 125.62127   ,
       141.53413   , 158.64922   , 176.39246   , 194.969     ],      dtype=float32))})), HierarchicalChoiceMap(trie=Trie(inner={'value': ChoiceValue(value=Array([ -0.29988667,   1.9623835 ,   4.338261  ,   8.128784  ,
        12.602457  ,  18.124142  ,  24.348125  ,  31.462566  ,
        40.482452  ,  49.124428  ,  59.449287  ,  70.73518   ,
        83.24687   ,  96.03866   , 109.91974   , 125.62127   ,
       141.53413   , 158.64922   , 176.39246   , 194.969     ],      dtype=float32))}))])}))), 'alpha': ChoiceValue(value=Array([0.12027554, 2.298516  , 1.9189827 ], dtype=float32))}))</code></pre>
</div>
</div>
<p>Here, I’m just showing a concise, pretty printed representation of the choice map – but it doesn’t tell us much about the values we truly care about here - the sampled values.</p>
<p>From this model, we can get these in two ways.</p>
<p>The first way: we can just look at the trace return value.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:53.378041Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:53.358371Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tr.get_retval()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Array([ -0.29988667,   1.9623835 ,   4.338261  ,   8.128784  ,
        12.602457  ,  18.124142  ,  24.348125  ,  31.462566  ,
        40.482452  ,  49.124428  ,  59.449287  ,  70.73518   ,
        83.24687   ,  96.03866   , 109.91974   , 125.62127   ,
       141.53413   , 158.64922   , 176.39246   , 194.969     ],      dtype=float32)</code></pre>
</div>
</div>
<p>The second way: we can get them out of the choice map of the trace directly.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:09:56.203345Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:09:56.186667Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>chm <span class="op">=</span> tr.get_choices()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [chm[<span class="st">"ys"</span>, i, <span class="st">"y"</span>, <span class="st">"value"</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data))]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[Mask(mask=Array(True, dtype=bool), value=Array(-0.29988667, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(1.9623835, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(4.338261, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(8.128784, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(12.602457, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(18.124142, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(24.348125, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(31.462566, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(40.482452, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(49.124428, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(59.449287, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(70.73518, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(83.24687, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(96.03866, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(109.91974, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(125.62127, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(141.53413, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(158.64922, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(176.39246, dtype=float32)),
 Mask(mask=Array(True, dtype=bool), value=Array(194.969, dtype=float32))]</code></pre>
</div>
</div>
<p>We’ve encountered something interesting: a <code>Mask</code> instance.</p>
<p>GenJAX uses <code>Mask</code> instances to represent uncertainty over dynamic values. Here, the <code>Mask</code> comes from the <code>SwitchCombinator</code> - because the branch of the <code>SwitchCombinator</code> can be dynamically chosen at runtime, we use <code>Mask</code> instances to denote valid vs.&nbsp;invalid data for inference computations.</p>
<p>With a <code>Mask</code> in hand, you can always attempt to <code>Mask.unmask</code> it.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T01:13:23.362504Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T01:13:23.341792Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>[v.unmask() <span class="cf">for</span> v <span class="kw">in</span> values]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[Array(-0.29988667, dtype=float32),
 Array(1.9623835, dtype=float32),
 Array(4.338261, dtype=float32),
 Array(8.128784, dtype=float32),
 Array(12.602457, dtype=float32),
 Array(18.124142, dtype=float32),
 Array(24.348125, dtype=float32),
 Array(31.462566, dtype=float32),
 Array(40.482452, dtype=float32),
 Array(49.124428, dtype=float32),
 Array(59.449287, dtype=float32),
 Array(70.73518, dtype=float32),
 Array(83.24687, dtype=float32),
 Array(96.03866, dtype=float32),
 Array(109.91974, dtype=float32),
 Array(125.62127, dtype=float32),
 Array(141.53413, dtype=float32),
 Array(158.64922, dtype=float32),
 Array(176.39246, dtype=float32),
 Array(194.969, dtype=float32)]</code></pre>
</div>
</div>
<p>Now, let’s construct a small visualization function to show us the samples.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T18:45:28.019545Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T18:45:27.708944Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(chm):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.vmap(<span class="kw">lambda</span> v: chm[<span class="st">"ys"</span>, v, <span class="st">"y"</span>, <span class="st">"value"</span>])(jnp.arange(<span class="dv">0</span>, <span class="bu">len</span>(data)))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> viz(ax, x, y, <span class="op">**</span>kwargs):</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    chm <span class="op">=</span> tr.get_choices()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> get_ys(chm).unmask()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    sns.scatterplot(x<span class="op">=</span>x, y<span class="op">=</span>y, ax<span class="op">=</span>ax, <span class="op">**</span>kwargs)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>f, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(model.simulate)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes.flatten():</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> jitted(key, (data,))</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> data</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> tr.get_retval()</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    viz(ax, x, y, marker<span class="op">=</span><span class="st">"."</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="intro_to_genjax_files/figure-html/cell-16-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>These are the <code>("ys", "y", "value")</code> samples for 9 traces from our model, against the points from the data we passed.</p>
<p>We just walked through one of the main elements of probabilistic programming: setting up a program, which represents a joint distribution over random variates, some of which we’ll identify with data we expect to see in the world.</p>
<p>We can adjust the noise settings of our model to produce wider priors over possible sets of points - and we may want to do this if our data is noisy!</p>
<p>For now, let’s keep the settings as is, and explore inference in GenJAX.</p>
</section>
<section id="your-first-inference-program" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="your-first-inference-program">Your first inference program</h2>
<p>Now, let’s say we have some data.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:53:45.251440Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:53:45.232848Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="fl">1.1</span>, <span class="fl">1.4</span>, <span class="fl">2.3</span>, <span class="fl">2.5</span>, <span class="fl">3.0</span>, <span class="fl">4.0</span>, <span class="fl">5.0</span>])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="fl">2.0</span> <span class="op">*</span> x <span class="op">+</span> <span class="fl">1.5</span> <span class="op">+</span> x<span class="op">**</span><span class="dv">2</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">2</span>] <span class="op">=</span> <span class="fl">50.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T00:53:47.288314Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T00:53:47.132289Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig_data, ax_data <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>viz(ax_data, x, y, color<span class="op">=</span><span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/seaborn/_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="intro_to_genjax_files/figure-html/cell-18-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>In Bayesian inference, if we wish to consider the conditional distribution <span class="math inline">\(P(\tau, r; x | \text{data})\)</span> induced from a model <span class="math inline">\(P(\tau, \text{data}, r; x)\)</span> - Bayes’ rule gives us a way to compute it.</p>
<p><span class="math display">\[
P(\tau, r; x | \text{data}) = \frac{P(\tau, \text{data}, r; x)}{\int P(\tau, \text{data}, r; x) \ d\tau}
\]</span></p>
<p>The problem is that we often cannot compute the denominator (<em>the evidence integral</em>) easily. Instead, we turn to <em>approximate</em> Bayesian inference.</p>
<p>Depending on how we wish to use the LHS conditional (which is called <em>the posterior</em> in Bayesian inference) - we have different options available to us.</p>
<p>If we wish to approximately sample from the posterior, to get an empirical sense of its shape and properties, we will often utilize techniques which provide exact samplers for another distribution which gets asymptotically close to the target posterior if we increase certain hyperparameters.</p>
<p>One such algorithm is <em>importance sampling</em>, and that’s what we’ll write today.</p>
<p>Here’s importance sampling (with a single sample) without a custom proposal in GenJAX.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T01:04:26.386021Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T01:04:24.635755Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>observations <span class="op">=</span> genjax.choice_map(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"ys"</span>: genjax.vector_choice_map(genjax.choice_map({(<span class="st">"y"</span>, <span class="st">"value"</span>): y}))}</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>(tr, w) <span class="op">=</span> model.importance(sub_key, observations, (x,))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/jax/_src/numpy/array_methods.py:64: UserWarning: Explicitly requested dtype &lt;class 'numpy.float64'&gt; requested in astype is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  return lax_numpy.astype(arr, dtype)
/Users/mccoybecker/miniconda3/envs/py311/lib/python3.11/site-packages/jax/_src/numpy/array_methods.py:64: UserWarning: Explicitly requested dtype float64 requested in astype is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  return lax_numpy.astype(arr, dtype)</code></pre>
</div>
</div>
<p>We’re introduced to another interface method!</p>
<p><code>importance</code> accepts a PRNG key, a choice map representing observations (sometimes called constraints), and model arguments. It returns a new evolved PRNG key, and a tuple contained a log <em>importance weight</em> and a trace.</p>
<p>The trace is consistent with the arguments and constraints passed into the invocation.</p>
<div class="cell" data-executetime="{&quot;end_time&quot;:&quot;2023-12-02T01:09:11.142192Z&quot;,&quot;start_time&quot;:&quot;2023-12-02T01:09:11.117371Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>[observations[<span class="st">"ys"</span>, i, <span class="st">"y"</span>, <span class="st">"value"</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(y))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>[2.19,
 3.3899999999999997,
 50.0,
 6.26,
 11.389999999999999,
 12.75,
 16.5,
 25.5,
 36.5]</code></pre>
</div>
</div>
<p>Let’s examine the weight now, and compare it to the score.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(w, tr.get_score())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>(Array(-35950.492, dtype=float32), Array(-35955.53, dtype=float32))</code></pre>
</div>
</div>
<p>Notice that these two quantities are different.</p>
<p>Remember: the score is the normalized log density of the choice map measure evaluated at the complete set of trace constraints. We’ll refer to complete traces by <span class="math inline">\(\tau\)</span>.</p>
<p>The log importance weight <code>w</code> is slightly different.</p>
<section id="importance-sampling-informally" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="importance-sampling-informally">Importance sampling, informally</h3>
<div class="page-columns page-full"><p>Let’s discuss how importance sampling works first<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn7"><p><sup>7</sup>&nbsp;In this notebook, I’ll defer discussing formal proofs concerning the asymptotic consistence of posterior estimators derived from importance sampling.</p></li></div></div>
<p>This will provide us with an understanding as to why <code>w</code> is different from the <code>score</code>.</p>
<p>More importantly, we’ll understand how we can use <code>importance</code> to solve the inference task of approximately sampling from the posterior over coefficients (and ultimately, over curves) from our generative function.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Importance sampling is typically presented by focusing on posterior expectations <span class="math inline">\(E_{x \sim P(x | y)}[f(x)]\)</span>.</p>
<p>In our case, we want to sample <span class="math inline">\(x \sim P(x | y)\)</span>. To do this, we’ll actually be considering a different procedure called <em>sampling importance resampling</em> or SIR for short.</p>
<p>Importantly, importance sampling is a subroutine in SIR.</p>
<p>We’ll discuss why importance sampling works here, and provide references to why SIR works to solve our problem.</p>
</div>
</div>
</div>
<p>Let’s start by considering two distributions which we can sample from, and evaluate densities.</p>
<div class="page-columns page-full"><p>Below, I’m plotting the densities of two distributions - a 1D Gaussian mixture and a 1D Gaussian<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn8"><p><sup>8</sup>&nbsp;GenJAX allows usage of TensorFlow Distributions as generative functions. Here, we’re just using the <code>logpdf</code> interface from distributions which expose exact <code>logpdf</code> evaluation - but <code>genjax</code> exports a wrapper which implements the complete generative function interface.</p></li></div></div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mix <span class="op">=</span> genjax.mixture(genjax.categorical, [genjax.normal, genjax.normal])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>mix_args <span class="op">=</span> ([<span class="fl">0.5</span>, <span class="fl">0.5</span>], [(<span class="op">-</span><span class="fl">3.0</span>, <span class="fl">0.8</span>), (<span class="fl">1.0</span>, <span class="fl">0.3</span>)])</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> genjax.normal</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>d_args <span class="op">=</span> (<span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>evaluation_points <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="fl">0.01</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_logpdf(ax, logpdf_fn, evaluation_points, <span class="op">**</span>kwargs):</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    logpdfs <span class="op">=</span> jax.vmap(logpdf_fn)(evaluation_points)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    ax.scatter(evaluation_points, jnp.exp(logpdfs), marker<span class="op">=</span><span class="st">"."</span>, <span class="op">**</span>kwargs)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>d_logpdf <span class="op">=</span> <span class="kw">lambda</span> v: d.logpdf(v, <span class="op">*</span>d_args)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>mix_logpdf <span class="op">=</span> <span class="kw">lambda</span> v: mix.logpdf(v, <span class="op">*</span>mix_args)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>plot_logpdf(ax, d_logpdf, evaluation_points, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"1D Gaussian PDF"</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>plot_logpdf(</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    mix_logpdf,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    evaluation_points,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"blue"</span>,</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"1D Gaussian mixture PDF"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>ax.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;matplotlib.legend.Legend at 0x16eb2fa10&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="intro_to_genjax_files/figure-html/cell-22-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>To gain context on importance sampling, imagine that the distribution which produces the blue curve is difficult to sample from - but it exposes a <code>logpdf</code> interface which we can use to evaluate the density at any point on the support of the distribution.</p>
<p>Now, suppose you hand me the distribution which made the red curve - and it is easy to sample from, and it also exposes a <code>logpdf</code> interface.</p>
<p>One thing we could do is sample from the red curve and then “correct” for the fact that we’re sampling from the wrong distribution.</p>
<p>This is the key intuition behind importance sampling.</p>
<p>Now, I’m going to write a procedure and ask you to just go with it … for a moment.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> importance_sample(hard, easy):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _inner(key, hard_args, easy_args):</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> easy.sample(key, <span class="op">*</span>easy_args)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        easy_logpdf <span class="op">=</span> easy.logpdf(sample, <span class="op">*</span>easy_args)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        hard_logpdf <span class="op">=</span> hard.logpdf(sample, <span class="op">*</span>hard_args)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        importance_weight <span class="op">=</span> hard_logpdf <span class="op">-</span> easy_logpdf</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (importance_weight, sample)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _inner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>hard <span class="op">=</span> genjax.mixture(genjax.categorical, [genjax.normal, genjax.normal])</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>easy <span class="op">=</span> genjax.normal</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(importance_sample(hard, easy))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>(importance_weight, sample) <span class="op">=</span> jitted(sub_key, mix_args, d_args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(importance_weight, sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(Array(-0.5798023, dtype=float32), Array(0.52931684, dtype=float32))</code></pre>
</div>
</div>
<p>Now, we can easily run this procedure many times in parallel.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(jax.vmap(importance_sample(hard, easy), in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>key, <span class="op">*</span>sub_keys <span class="op">=</span> jax.random.split(key, <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>sub_keys <span class="op">=</span> jnp.array(sub_keys)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>(importance_weight, sample) <span class="op">=</span> jitted(sub_keys, mix_args, d_args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>importance_weight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>Array([ -5.222172  ,  -5.1568213 ,  -4.287818  ,   0.81328297,
        -5.8420143 ,  -4.714349  ,  -1.8759232 ,  -0.02162004,
        -2.9115887 ,  -5.9263754 ,  -2.8600068 ,  -6.1821055 ,
        -0.6048572 ,   0.16871619,  -0.5644634 ,  -3.10139   ,
         1.4178798 ,   0.9687687 ,   1.0298468 ,  -4.099892  ,
         0.8798984 ,  -3.055994  ,  -4.197502  ,  -3.3250515 ,
        -3.0528302 ,  -1.8012767 ,   1.0291557 ,   0.67581177,
        -5.5933228 ,  -0.0878166 ,  -4.3786573 ,   0.94431734,
        -7.08412   ,   0.05408978,   1.0017878 ,  -4.7431726 ,
        -2.7999394 ,  -2.1933444 ,   0.96262884,  -4.5651693 ,
        -4.2186637 ,  -4.843083  ,  -2.573883  ,  -0.27608478,
         1.0572839 ,   0.9986682 ,  -4.7879486 ,  -0.8544862 ,
        -4.713733  ,  -3.4609752 ,   0.8476291 ,  -0.88302493,
        -6.8909297 ,  -3.3653176 ,   4.2992773 ,  -2.2809062 ,
        -4.6530714 ,   0.8560004 ,  -6.069036  ,   1.0599239 ,
         1.0440462 ,  -2.7001753 ,  -4.930687  ,  -1.9733105 ,
        -4.3531437 ,   3.5103688 ,  -1.9808583 ,   0.51805174,
         0.58433825,   1.0549145 ,  -0.43572462,  -4.195882  ,
         2.0064235 ,  -5.255489  , -15.036494  ,  -4.15064   ,
         0.49936044,  -0.5565939 ,  -3.61314   ,  -4.4685197 ,
        -1.4676603 ,  -3.9543266 ,   0.33754468,  -0.04271436,
        -0.43233287,  -2.1609077 ,  -3.292367  ,  -0.90873945,
        -5.371378  ,   0.7410506 ,  -1.859757  ,   0.86502385,
         0.6106868 ,  -6.1862593 ,  -5.2144914 ,  -1.3959342 ,
        -3.4834352 ,  -6.201556  ,  -5.552056  ,   0.8627597 ],      dtype=float32)</code></pre>
</div>
</div>
<p>We’re just sampling from <code>easy</code>, then scoring the samples with <code>importance_weight</code> according to the log ratio <code>easy_logpdf(sample) - hard_logpdf(sample)</code>.</p>
<p>Here’s the trick - from our collection of samples and weights, let’s normalize the weights into a distribution and sample a single sample to return using it.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sampling_importance_resampling(hard, easy, n_samples):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _inner(key, hard_args, easy_args):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        fn <span class="op">=</span> importance_sample(hard, easy)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        resample_key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        sub_keys <span class="op">=</span> jax.random.split(key, n_samples)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        vmapped <span class="op">=</span> jax.vmap(fn, in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        (ws, samples) <span class="op">=</span> vmapped(sub_keys, hard_args, easy_args)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> ws</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> genjax.categorical.sample(resample_key, logits)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        final_sample <span class="op">=</span> samples[index]</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> final_sample</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _inner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>hard <span class="op">=</span> genjax.mixture(genjax.categorical, [genjax.normal, genjax.normal])</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>easy <span class="op">=</span> genjax.normal</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(sampling_importance_resampling(hard, easy, <span class="dv">100</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> jitted(sub_key, mix_args, d_args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>Array(1.4641739, dtype=float32)</code></pre>
</div>
</div>
<p>Let’s run this procedure a bunch of times and plot the points on the x-axis of our plot above.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_on_x(ax, x, <span class="op">**</span>kwargs):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    ax.scatter(x, np.zeros_like(x), <span class="op">**</span>kwargs)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>key, <span class="op">*</span>sub_keys <span class="op">=</span> jax.random.split(key, <span class="dv">1000</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>sub_keys <span class="op">=</span> jnp.array(sub_keys)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>fn <span class="op">=</span> sampling_importance_resampling(hard, easy, <span class="dv">1000</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(jax.vmap(fn, in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>)))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> jitted(sub_keys, mix_args, d_args)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>plot_on_x(ax, samples, color<span class="op">=</span><span class="st">"gold"</span>, marker<span class="op">=</span><span class="st">"."</span>, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<p><img src="intro_to_genjax_files/figure-html/cell-32-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Notice what happens with the SIR samples (in gold)?</p>
<p>They accumulate around the places you’d expect to see if you were sampling from the <code>hard</code> distribution!</p>
<div class="page-columns page-full"><p>That’s what importance sampling and sampling importance sampling give us - we provide a “hard” distribution with a <code>logpdf</code> interface, and another “easy” distribution with <code>sample</code> and <code>logpdf</code> interface<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, and SIR returns an exact sampler for a distribution which approximates the hard distribution.</p><div class="no-row-height column-margin column-container"><li id="fn9"><p><sup>9</sup>&nbsp;There are more constraints. The second distribution must be <em>absolutely continuous</em> in measure with respect to the first. Let’s defer this discussion to a formal treatment of importance sampling.</p></li></div></div>
</section>
<section id="back-to-our-generative-function" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="back-to-our-generative-function">Back to our generative function</h3>
<p>Now that we’ve seen the ingredients and implementation of importance sampling and sampling importance resampling - let’s return to our original problem.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fig_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<p><img src="intro_to_genjax_files/figure-html/cell-33-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>If you studied the previous section careful - one question might jump out at you: what is the “easy” distribution for <code>model.importance</code>?</p>
<section id="builtin-proposals" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="builtin-proposals">Builtin proposals</h4>
<p>Generative functions defined using the <code>BuiltinGenerativeFunction</code> language come with builtin proposals - it’s a distribution (which we’ll refer to as <span class="math inline">\(Q\)</span>) induced from the prior, with sampling and <code>score</code> defined ancestrally.</p>
<div class="page-columns page-full"><p>Give observation constraints <span class="math inline">\(u\)</span>, the importance weight which <code>model.importance</code> computes is<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>:</p><div class="no-row-height column-margin column-container"><li id="fn10"><p><sup>10</sup>&nbsp;This definition again considers “untraced randomness” <span class="math inline">\(r\)</span>. If you wish to ignore this in the math, just remove the <span class="math inline">\(Q(r; x, \tau)\)</span> term. Even in the presence of untraced randomness, the weights which Gen computes are asymptotically consistent in expectation over <span class="math inline">\(Q(r; x, \tau)\)</span></p></li></div></div>
<p><span class="math display">\[
\begin{align}
\log w &amp;= \log P(\tau, r; x) - \log Q(\tau; u, x)Q(r; x, \tau) \\
\end{align}
\]</span></p>
<p>For the <code>BuiltinGenerativeFunction</code> language, we implement <span class="math inline">\(Q\)</span> by invoking the generative function - when we arrive at a constrained address, we recursively called <code>submodel.importance</code> - accumulate the log weight, as well as the log score.</p>
<p>Now, if an address has no constraints - we get <code>0.0</code> for the weight (think about why this is by looking at the above equation and asking what happens when <span class="math inline">\(Q\)</span> has to generate a full <span class="math inline">\(\tau\)</span>). However, we still get a score.</p>
</section>
<section id="sequential-importance-resampling-in-genjax" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="sequential-importance-resampling-in-genjax">Sequential importance resampling in GenJAX</h4>
<div class="page-columns page-full"><p>Here’s SIR using builtin proposals (just a single call to <code>model.importance</code>) in GenJAX<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>:</p><div class="no-row-height column-margin column-container"><li id="fn11"><p><sup>11</sup>&nbsp;To implement a variant with custom proposals, all we need to do is first <code>proposal.simulate</code>, merge the proposal choice map with the constraints, then <code>model.importance</code> followed by a final weight adjustment <code>w = w - proposal_tr.get_score()</code> - easy peasy.</p></li></div></div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sampling_importance_resampling(model, n_samples):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _inner(key, observations, model_args):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        resample_key, sub_key <span class="op">=</span> jax.random.split(key)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        sub_keys <span class="op">=</span> jax.random.split(sub_key, n_samples)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        vmapped <span class="op">=</span> jax.vmap(model.importance, in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        (trs, lws) <span class="op">=</span> vmapped(sub_keys, observations, model_args)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        index <span class="op">=</span> genjax.categorical.sample(resample_key, lws)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        final_tr <span class="op">=</span> jtu.tree_map(<span class="kw">lambda</span> v: v[index], trs)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> final_tr</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _inner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One difference between our first implementation (on just distributions) above and this one is that <code>Trace</code> instances are structured objects (but all of them are <code>Pytree</code> implementors) - meaning we need to index into the leaves when we wish to return a single sampled trace.</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>model_args <span class="op">=</span> (x,)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    jax.vmap(sampling_importance_resampling(model, <span class="dv">100</span>), in_axes<span class="op">=</span>(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>key, <span class="op">*</span>sub_keys <span class="op">=</span> jax.random.split(key, <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>sub_keys <span class="op">=</span> jnp.array(sub_keys)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> jitted(sub_keys, observations, model_args)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> samples[<span class="st">"alpha"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So now we have an approximate sampler for the posterior and we can use it to look at properties of the posterior - like what sort of curves are likely given our data and our model prior.</p>
<div class="page-columns page-full"><p>… and by the way, to get a representative set of samples from the posterior for this model, on an Apple M2 device - only takes about 0.05 seconds<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn12"><p><sup>12</sup>&nbsp;Just remember: we’re running this notebook on CPU - but the resulting specialized inference code can easily be moved to accelerators, courtesy of the fact that all our code is JAX traceable.</p></li></div></div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>timeit</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> jitted(sub_keys, observations, model_args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>30.5 ms ± 1.31 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> polynomial_at_x(x, coefficients):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    basis_values <span class="op">=</span> jnp.array([<span class="fl">1.0</span>, x, x<span class="op">**</span><span class="dv">2</span>])</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    polynomial_value <span class="op">=</span> jnp.<span class="bu">sum</span>(coefficients <span class="op">*</span> basis_values)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> polynomial_value</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>jitted <span class="op">=</span> jax.jit(jax.vmap(polynomial_at_x, in_axes<span class="op">=</span>(<span class="va">None</span>, <span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="37">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_polynomial_values(ax, x, coefficients, <span class="op">**</span>kwargs):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> jitted(x, coefficients)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    ax.scatter(np.repeat(x, <span class="bu">len</span>(v)), v, <span class="op">**</span>kwargs)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> samples[<span class="st">"alpha"</span>]</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>evaluation_points <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">5</span>, <span class="fl">0.01</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> data <span class="kw">in</span> evaluation_points:</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    plot_polynomial_values(</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        ax_data, data, coefficients, marker<span class="op">=</span><span class="st">"."</span>, color<span class="op">=</span><span class="st">"gold"</span>, alpha<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>fig_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<p><img src="intro_to_genjax_files/figure-html/cell-38-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>Intuitively, this makes a lot of sense. Our prior over polynomials considers a wide range of curves - but, if our approximate sampling process is trusted, we’re correctly seeing what we should expect to happen if we observed this data - polynomials with the coefficients shown above tend to be sampled more under the posterior.</p>
<p>We can also ask for an estimate of the posterior probability that any particle point was an outlier.</p>
<p>For example, below is the set of samples projected onto the <code>("ys", "outlier")</code> address for the point which we manually set to be quite far from the curve.</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>chs <span class="op">=</span> samples.get_choices()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>outlier_at_2 <span class="op">=</span> chs[<span class="st">"ys"</span>, :, <span class="st">"outlier"</span>][:, <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(outlier_at_2) <span class="op">/</span> <span class="bu">len</span>(outlier_at_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>Array(1., dtype=float32)</code></pre>
</div>
</div>
<p>That seems to make sense! We pulled that point quite far away from ground truth curve - so we’d expect that point 2 is considered an outlier under the true posterior.</p>
</section>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We’ve covered a lot of ground in this notebook. Please reflect, re-read, and post issues!</p>
<ul>
<li>We discussed the Gen probabilistic programming framework, and discussed GenJAX - an implementation of Gen on top of JAX.</li>
<li>We discussed <em>generative functions</em> - the main computational object of Gen.</li>
<li>We discussed how to create generative functions using <em>generative function languages</em>, and several of GenJAX’s builtin capabilities for constructing generative functions.</li>
<li>We discussed how to use generative functions to represent joint probability distributions, which can be used to construct models of phenomena.</li>
<li>We created a generative function to model a data-generating process based on sampling and evaluating random polynomials at input data - to represent a typical regression task.</li>
<li>We discussed how to formulate questions about induced conditional distributions under a probabilistic model as a Bayesian inference problem.</li>
<li>We discussed importance sampling and sampling importance resampling, two central techniques in approximate Bayesian inference.</li>
<li>We created a sampling importance resampling routine and applied it to produce approximate posterior samples from the posterior in the our polynomial generating model.</li>
<li>We investigated the approximate posterior samples, and visually inspected that they match the inferences that we might draw - both for the polynomials we expected to produce the data, as well as what data points might be outliers.</li>
</ul>
<p>This is just the beginning! There’s a lot more to learn, but plenty to bite off with this initial notebook.</p>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../concepts/combinators/intro_to_combinators.html" class="pagination-link">
        <span class="nav-page-text">(WIP) Generative function combinators</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">© Copyright 2022 <a href="http://probcomp.csail.mit.edu/">MIT Probabilistic Computing Project</a></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>